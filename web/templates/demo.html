{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-6 py-12">
    <div class="flex justify-between items-center mb-8 animate__animated animate__fadeInDown">
        <h1 class="text-5xl font-black uppercase tracking-tighter flex items-center gap-4">
            <span class="text-red-600 animate-pulse">■</span>
            Combat <span class="gradient-text">Simulation</span>
        </h1>
        
        <div class="flex gap-4 items-center">
            <select id="model-select" class="bg-black border-2 border-red-900/50 text-stone-300 rounded-none px-4 py-2 focus:ring-2 focus:ring-red-600 focus:border-red-600 font-mono text-xs uppercase tracking-widest transition-all hover:border-red-700 cursor-pointer">
                <option value="latest">LATEST MODEL</option>
                <option value="random">RANDOM CHAOS</option>
            </select>
            <button id="btn-execute" onclick="runSimulation()" class="cyber-btn group flex items-center gap-3">
                <svg class="w-5 h-5 group-hover:rotate-90 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="square" stroke-linejoin="miter" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span id="btn-execute-text">EXECUTE</span>
            </button>
            <button id="btn-stop" onclick="stopPlayback()" class="px-4 py-2 border border-stone-700 text-stone-500 font-bold uppercase tracking-widest text-xs hover:bg-red-900/20 hover:text-red-500 hover:border-red-900 transition-all hidden">
                STOP
            </button>
        </div>
    </div>
    
    <!-- CONTROL PANEL -->
    <div class="warrior-border bg-black/90 backdrop-blur p-4 mb-8 animate__animated animate__fadeInDown animate__delay-1s">
        <div class="flex items-center gap-2 mb-4 border-b border-red-900/50 pb-2">
            <span class="w-2 h-2 bg-red-600 animate-pulse"></span>
            <h3 class="text-sm font-bold uppercase text-red-500 tracking-widest">Mission Parameters</h3>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
            <!-- Trajectory Type -->
            <div class="space-y-1">
                <label class="text-xs font-mono text-stone-500 uppercase">Target Pattern</label>
                <select id="trajectory-type" class="w-full bg-black border border-red-900/50 text-stone-300 rounded-none px-2 py-2 font-mono text-xs uppercase focus:ring-1 focus:ring-red-600 focus:border-red-600 cursor-pointer">
                    <option value="lissajous">Lissajous</option>
                    <option value="stationary">Stationary</option>
                    <option value="linear">Linear</option>
                    <option value="circular">Circular</option>
                    <option value="figure_eight">Figure-8</option>
                    <option value="spiral_dive">Spiral Dive</option>
                    <option value="lissajous_perlin">Lissajous+Noise</option>
                    <option value="random_walk">Random Walk</option>
                    <option value="zigzag">Zigzag</option>
                    <option value="drunk_walk">Drunk Walk</option>
                    <option value="chaotic">Chaotic</option>
                    <option value="evasive" selected>Evasive</option>
                    <option value="predator">Predator</option>
                </select>
            </div>
            
            <!-- Target Speed -->
            <div class="space-y-1">
                <label class="text-xs font-mono text-stone-500 uppercase">Target Speed</label>
                <div class="flex items-center gap-2">
                    <input type="range" id="target-speed" min="0.1" max="3.0" step="0.1" value="1.0" class="flex-1 accent-red-600 h-2">
                    <span id="target-speed-val" class="text-stone-300 font-mono text-xs w-10 text-right">1.0x</span>
                </div>
            </div>
            
            <!-- Playback Speed -->
            <div class="space-y-1">
                <label class="text-xs font-mono text-stone-500 uppercase">Playback</label>
                <div class="flex items-center gap-2">
                    <input type="range" id="speed-control" min="0.1" max="3.0" step="0.1" value="1.0" class="flex-1 accent-red-600 h-2">
                    <span id="speed-val" class="text-stone-300 font-mono text-xs w-10 text-right">1.0x</span>
                </div>
            </div>
            
            <!-- Perturbation Level -->
            <div class="space-y-1">
                <label class="text-xs font-mono text-stone-500 uppercase">Perturbation</label>
                <div class="flex items-center gap-2">
                    <input type="range" id="perturbation" min="0" max="1" step="0.1" value="0" class="flex-1 accent-red-600 h-2">
                    <span id="perturbation-val" class="text-stone-300 font-mono text-xs w-10 text-right">0%</span>
                </div>
            </div>
            
            <!-- Wind Speed -->
            <div class="space-y-1">
                <label class="text-xs font-mono text-stone-500 uppercase">Wind Speed</label>
                <div class="flex items-center gap-2">
                    <input type="range" id="wind-speed" min="0" max="10" step="0.5" value="0" class="flex-1 accent-red-600 h-2">
                    <span id="wind-speed-val" class="text-stone-300 font-mono text-xs w-12 text-right">0 m/s</span>
                </div>
            </div>
            
            <!-- Wind Direction -->
            <div class="space-y-1">
                <label class="text-xs font-mono text-stone-500 uppercase">Wind Dir</label>
                <div class="flex items-center gap-2">
                    <input type="range" id="wind-dir" min="0" max="360" step="15" value="0" class="flex-1 accent-red-600 h-2">
                    <span id="wind-dir-val" class="text-stone-300 font-mono text-xs w-10 text-right">N</span>
                </div>
            </div>
            
            <!-- Episode Length -->
            <div class="space-y-1">
                <label class="text-xs font-mono text-stone-500 uppercase">Duration</label>
                <div class="flex items-center gap-2">
                    <input type="range" id="episode-length" min="50" max="500" step="50" value="200" class="flex-1 accent-red-600 h-2">
                    <span id="episode-length-val" class="text-stone-300 font-mono text-xs w-10 text-right">200</span>
                </div>
            </div>
        </div>
        
        <!-- Difficulty Indicator -->
        <div class="mt-4 pt-3 border-t border-red-900/30 flex items-center gap-4">
            <span class="text-xs font-mono text-stone-600 uppercase">Difficulty:</span>
            <div class="flex gap-1" id="difficulty-indicator">
                <span class="w-3 h-3 bg-red-900/30"></span>
                <span class="w-3 h-3 bg-red-900/30"></span>
                <span class="w-3 h-3 bg-red-900/30"></span>
                <span class="w-3 h-3 bg-red-900/30"></span>
                <span class="w-3 h-3 bg-red-900/30"></span>
                <span class="w-3 h-3 bg-red-900/30"></span>
                <span class="w-3 h-3 bg-red-900/30"></span>
                <span class="w-3 h-3 bg-red-900/30"></span>
                <span class="w-3 h-3 bg-red-900/30"></span>
                <span class="w-3 h-3 bg-red-900/30"></span>
            </div>
            <span id="difficulty-label" class="text-xs font-mono text-red-500 uppercase">Moderate</span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Visualization Canvas -->
        <div class="lg:col-span-2 warrior-border bg-black p-0 overflow-hidden relative group animate__animated animate__fadeInLeft animate__delay-1s">
            <!-- HUD Overlays -->
            <div class="absolute inset-0 pointer-events-none z-20">
                <!-- Corners -->
                <div class="absolute top-4 left-4 w-16 h-16 border-t-2 border-l-2 border-red-600/50"></div>
                <div class="absolute top-4 right-4 w-16 h-16 border-t-2 border-r-2 border-red-600/50"></div>
                <div class="absolute bottom-4 left-4 w-16 h-16 border-b-2 border-l-2 border-red-600/50"></div>
                <div class="absolute bottom-4 right-4 w-16 h-16 border-b-2 border-r-2 border-red-600/50"></div>
                
                <!-- Center Crosshair (Fixed Camera Bore-sight) -->
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
                    <div class="w-8 h-8 border border-red-500/30 rounded-full"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-1 h-4 bg-red-500/50"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-4 h-1 bg-red-500/50"></div>
                </div>

                <!-- Status Labels -->
                <div class="absolute top-6 left-8 font-mono text-xs text-red-500 tracking-widest flex flex-col gap-1">
                    <span>CAM_MODE: ACTIVE_TRACK</span>
                    <span>SENSOR: OPTICAL_01</span>
                    <span id="fps-display">FPS: 60</span>
                </div>
                
                <div class="absolute bottom-6 right-8 font-mono text-xs text-red-500 tracking-widest text-right">
                    <span class="animate-pulse">● RECORDING</span>
                </div>
            </div>

            <canvas id="simCanvas" width="800" height="600" class="w-full h-auto bg-black cursor-crosshair"></canvas>
            
            <div id="loading" class="absolute inset-0 bg-black/90 flex flex-col items-center justify-center hidden backdrop-blur-sm z-50">
                <div class="animate-spin h-16 w-16 border-4 border-t-red-600 border-r-red-900 border-b-red-900 border-l-red-900 rounded-full mb-4 shadow-[0_0_20px_red]"></div>
                <span class="text-red-500 font-mono animate-pulse tracking-widest">INITIALIZING_OPTICS...</span>
            </div>
        </div>

        <!-- Metrics Panel -->
        <div class="space-y-6">
            <div class="warrior-border bg-black/80 backdrop-blur p-6 animate__animated animate__fadeInRight animate__delay-2s">
                <h3 class="text-lg font-bold mb-6 uppercase text-stone-200 tracking-widest border-b border-red-900/50 pb-2 flex justify-between items-center">
                    Target Data
                    <span class="w-2 h-2 bg-red-600 animate-pulse"></span>
                </h3>
                <div class="space-y-4 font-mono text-sm">
                    <div class="flex justify-between items-center group">
                        <span class="text-red-900 group-hover:text-red-500 transition-colors">LOCK_STATUS</span>
                        <span id="lock-status" class="text-stone-500 font-bold">SEARCHING</span>
                    </div>
                    <div class="flex justify-between items-center group">
                        <span class="text-red-900 group-hover:text-red-500 transition-colors">RANGE</span>
                        <span id="range-display" class="text-2xl text-white font-black">0.00m</span>
                    </div>
                    <div class="flex justify-between items-center group">
                        <span class="text-red-900 group-hover:text-red-500 transition-colors">AZIMUTH_ERR</span>
                        <span id="azimuth-display" class="text-stone-300">0.0°</span>
                    </div>
                    <div class="flex justify-between items-center group">
                        <span class="text-red-900 group-hover:text-red-500 transition-colors">ELEVATION_ERR</span>
                        <span id="elevation-display" class="text-stone-300">0.0°</span>
                    </div>
                </div>
            </div>

            <div class="warrior-border bg-black/80 backdrop-blur p-6 animate__animated animate__fadeInRight animate__delay-3s">
                <h3 class="text-lg font-bold mb-6 uppercase text-stone-200 tracking-widest border-b border-red-900/50 pb-2">Tracking Performance</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-stone-500 font-mono text-sm">REWARD</span>
                        <span id="reward-display" class="font-black text-red-500 text-2xl font-mono tracking-tighter">-</span>
                    </div>
                    
                    <!-- Error Bars -->
                    <div class="space-y-1">
                        <div class="flex justify-between text-xs font-mono text-stone-500">
                            <span>H-ERROR</span>
                            <span id="h-error-val">0%</span>
                        </div>
                        <div class="h-1 bg-stone-900 w-full">
                            <div id="h-error-bar" class="h-full bg-red-600 w-0 transition-all duration-100"></div>
                        </div>
                    </div>
                    
                    <div class="space-y-1">
                        <div class="flex justify-between text-xs font-mono text-stone-500">
                            <span>V-ERROR</span>
                            <span id="v-error-val">0%</span>
                        </div>
                        <div class="h-1 bg-stone-900 w-full">
                            <div id="v-error-bar" class="h-full bg-red-600 w-0 transition-all duration-100"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
                <h3 class="text-lg font-bold mb-2 uppercase text-stone-400 tracking-widest border-b border-red-900/50 pb-2">Radar Legend</h3>
                <div class="flex items-center gap-3 mb-2">
                    <span class="w-3 h-3 bg-white border border-red-500 shadow-[0_0_5px_white]"></span>
                    <span class="text-xs text-stone-500 font-mono uppercase">Drone (The Blade)</span>
                </div>
                <div class="flex items-center gap-3 mb-2">
                    <span class="w-3 h-3 bg-red-600 border border-red-900 shadow-[0_0_10px_red]"></span>
                    <span class="text-xs text-stone-500 font-mono uppercase">Target (The Enemy)</span>
                </div>
                 <div class="flex items-center gap-3">
                    <span class="w-3 h-3 bg-red-900/50"></span>
                    <span class="text-xs text-stone-500 font-mono uppercase">Path Trace</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    
    // Physics & Camera Constants
    const SCALE = 100; // pixels per meter (Zoom level)
    const DT = 0.05;  // Simulation timestep (s)
    const FOV_SCALE = 600; // Reduced from 1000 for wider FOV (Wide Angle Lens)
    
    // State
    let animationId;
    let lastFrameTime = 0;
    let accumulatedTime = 0;
    let playbackSpeed = 1.0;
    
    // Difficulty mapping for trajectory types
    const difficultyMap = {
        'stationary': 1, 'linear': 2, 'circular': 3, 'lissajous': 4,
        'figure_eight': 4, 'spiral_dive': 5, 'lissajous_perlin': 6,
        'random_walk': 6, 'zigzag': 7, 'drunk_walk': 7, 'chaotic': 8,
        'evasive': 9, 'predator': 10
    };
    
    const difficultyLabels = [
        '', 'Trivial', 'Easy', 'Simple', 'Moderate', 'Challenging',
        'Hard', 'Very Hard', 'Extreme', 'Nightmare', 'IMPOSSIBLE'
    ];
    
    // Wind direction labels
    function getWindDirLabel(deg) {
        const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
        return dirs[Math.round(deg / 45) % 8];
    }
    
    // Update difficulty indicator
    function updateDifficulty() {
        const trajType = document.getElementById('trajectory-type').value;
        const perturbation = parseFloat(document.getElementById('perturbation').value);
        const windSpeed = parseFloat(document.getElementById('wind-speed').value);
        const targetSpeed = parseFloat(document.getElementById('target-speed').value);
        
        // Base difficulty from trajectory
        let diff = difficultyMap[trajType] || 5;
        
        // Modifiers
        diff += Math.floor(perturbation * 2);
        diff += Math.floor(windSpeed / 5);
        diff += Math.floor((targetSpeed - 1) * 2);
        diff = Math.min(10, Math.max(1, diff));
        
        // Update visual
        const indicator = document.getElementById('difficulty-indicator');
        const spans = indicator.querySelectorAll('span');
        spans.forEach((span, i) => {
            if (i < diff) {
                span.className = 'w-3 h-3 bg-red-600 shadow-[0_0_8px_red]';
            } else {
                span.className = 'w-3 h-3 bg-red-900/30';
            }
        });
        document.getElementById('difficulty-label').innerText = difficultyLabels[diff];
    }
    
    // UI Event Listeners
    document.getElementById('speed-control').addEventListener('input', (e) => {
        playbackSpeed = parseFloat(e.target.value);
        document.getElementById('speed-val').innerText = playbackSpeed.toFixed(1) + 'x';
    });
    
    document.getElementById('target-speed').addEventListener('input', (e) => {
        document.getElementById('target-speed-val').innerText = parseFloat(e.target.value).toFixed(1) + 'x';
        updateDifficulty();
    });
    
    document.getElementById('perturbation').addEventListener('input', (e) => {
        document.getElementById('perturbation-val').innerText = Math.round(parseFloat(e.target.value) * 100) + '%';
        updateDifficulty();
    });
    
    document.getElementById('wind-speed').addEventListener('input', (e) => {
        document.getElementById('wind-speed-val').innerText = parseFloat(e.target.value).toFixed(1) + ' m/s';
        updateDifficulty();
    });
    
    document.getElementById('wind-dir').addEventListener('input', (e) => {
        document.getElementById('wind-dir-val').innerText = getWindDirLabel(parseFloat(e.target.value));
    });
    
    document.getElementById('episode-length').addEventListener('input', (e) => {
        document.getElementById('episode-length-val').innerText = e.target.value;
    });
    
    document.getElementById('trajectory-type').addEventListener('change', updateDifficulty);
    
    // Initialize difficulty on load
    updateDifficulty();
    
    // Fix: Initialize all slider displays on page load
    document.getElementById('target-speed-val').innerText = document.getElementById('target-speed').value + 'x';
    document.getElementById('speed-val').innerText = document.getElementById('speed-control').value + 'x';
    document.getElementById('perturbation-val').innerText = Math.round(document.getElementById('perturbation').value * 100) + '%';
    document.getElementById('wind-speed-val').innerText = document.getElementById('wind-speed').value + ' m/s';
    document.getElementById('wind-dir-val').innerText = getWindDirLabel(parseFloat(document.getElementById('wind-dir').value));
    document.getElementById('episode-length-val').innerText = document.getElementById('episode-length').value;

    let starfield = []; // Background particles

    // Initialize Starfield
    for(let i=0; i<100; i++) {
        starfield.push({
            x: Math.random() * 2000 - 1000,
            y: Math.random() * 2000 - 1000,
            z: Math.random() * 2000 // depth
        });
    }

    let isPlaying = false;
    
    function stopPlayback() {
        if (animationId) {
            cancelAnimationFrame(animationId);
            animationId = null;
        }
        isPlaying = false;
        document.getElementById('btn-stop').classList.add('hidden');
        document.getElementById('btn-execute-text').innerText = 'EXECUTE';
    }
    
    async function runSimulation() {
        // Stop any running playback
        stopPlayback();
        
        const modelType = document.getElementById('model-select').value;
        const trajectoryType = document.getElementById('trajectory-type').value;
        const targetSpeed = document.getElementById('target-speed').value;
        const perturbation = document.getElementById('perturbation').value;
        const windSpeed = document.getElementById('wind-speed').value;
        const windDir = document.getElementById('wind-dir').value;
        const episodeLength = document.getElementById('episode-length').value;
        
        const loading = document.getElementById('loading');
        const btnExecute = document.getElementById('btn-execute');
        const btnStop = document.getElementById('btn-stop');
        
        loading.classList.remove('hidden');
        btnExecute.disabled = true;
        document.getElementById('btn-execute-text').innerText = 'LOADING...';
        
        try {
            const params = new URLSearchParams({
                model_type: modelType,
                trajectory_type: trajectoryType,
                target_speed: targetSpeed,
                perturbation_level: perturbation,
                wind_speed: windSpeed,
                wind_direction: windDir,
                episode_length: episodeLength
            });
            
            const response = await fetch(`/api/run-simulation?${params}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            loading.classList.add('hidden');
            btnExecute.disabled = false;
            document.getElementById('btn-execute-text').innerText = 'RESTART';
            btnStop.classList.remove('hidden');
            
            document.getElementById('reward-display').innerText = data.reward.toFixed(2);
            
            isPlaying = true;
            startPlayback(data);
            
        } catch (error) {
            console.error('Simulation error:', error);
            loading.classList.add('hidden');
            btnExecute.disabled = false;
            document.getElementById('btn-execute-text').innerText = 'EXECUTE';
            document.getElementById('lock-status').innerText = 'ERROR';
            document.getElementById('lock-status').className = 'text-red-500 font-bold';
        }
    }

    function startPlayback(data) {
        if (animationId) cancelAnimationFrame(animationId);
        
        let step = 0;
        const totalSteps = data.drone_pos.length;
        lastFrameTime = performance.now();
        accumulatedTime = 0;
        
        // Pre-calculate relative positions (What the camera sees)
        // Drone is camera. Target is object.
        // We need target position relative to drone.
        // In the simulator: target_pos_ned - drone_pos_ned = relative vector in NED
        // But we want it in Body Frame (Camera Frame).
        // Since we don't have rotation matrix in the JSON (simplified), 
        // we will approximate assuming drone faces North or use velocity for orientation.
        // For this demo: We will visualize relative position in NED (simpler) or
        // assume Camera is locked to North. 
        // Better: Just visualize (Target - Drone) in 2D Screen Space.
        
        function draw(currentTime) {
            // Time sync
            const deltaTime = (currentTime - lastFrameTime) / 1000;
            lastFrameTime = currentTime;
            
            // Apply speed multiplier
            accumulatedTime += deltaTime * playbackSpeed;

            // Update FPS
            if (Math.random() < 0.1) {
                document.getElementById('fps-display').innerText = `FPS: ${Math.round(1/deltaTime)}`;
            }

            if (accumulatedTime >= DT) {
                step++;
                accumulatedTime -= DT;
            }

            if (step >= totalSteps) {
                // End of playback
                isPlaying = false;
                document.getElementById('btn-stop').classList.add('hidden');
                document.getElementById('btn-execute-text').innerText = 'REPLAY';
                document.getElementById('lock-status').innerText = 'COMPLETE';
                document.getElementById('lock-status').className = 'text-green-500 font-bold';
                return;
            }
            
            const dronePos = data.drone_pos[step];
            const targetPos = data.target_pos[step];
            const droneVel = data.drone_vel[step];
            
            // Relative Position (Target relative to Drone)
            const relX = targetPos[0] - dronePos[0]; // North (Forward/Back)
            const relY = targetPos[1] - dronePos[1]; // East (Right/Left)
            const relZ = targetPos[2] - dronePos[2]; // Down (Up/Down)
            
            // Camera Coordinate System transformation
            // Cam Z = Forward (North) -> relX
            // Cam X = Right (East) -> relY
            // Cam Y = Down (Down) -> relZ
            
            const dist = Math.sqrt(relX**2 + relY**2 + relZ**2);
            
            // Clear Screen
            ctx.fillStyle = '#050505';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 1. Draw "Starfield" (Motion Effect)
            // Move stars based on drone velocity
            // droneVel is [North, East, Down] -> [Z, X, Y] for camera
            const velZ = droneVel[0] * 5; // Forward speed
            const velX = droneVel[1] * 5; // Side speed
            const velY = droneVel[2] * 5; // Vertical speed
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            starfield.forEach(star => {
                star.z -= velZ;
                star.x -= velX;
                star.y -= velY;
                
                if (star.z < 1) star.z += 2000;
                if (star.z > 2000) star.z -= 2000;
                if (star.x < -1000) star.x += 2000;
                if (star.x > 1000) star.x -= 2000;
                if (star.y < -1000) star.y += 2000;
                if (star.y > 1000) star.y -= 2000;
                
                // Project star
                const k = FOV_SCALE / (star.z + 100); // depth scale
                const sx = canvas.width/2 + star.x * k;
                const sy = canvas.height/2 + star.y * k;
                
                if (sx > 0 && sx < canvas.width && sy > 0 && sy < canvas.height) {
                    const size = Math.max(1, (1 - star.z/2000) * 3);
                    ctx.beginPath();
                    ctx.arc(sx, sy, size, 0, Math.PI*2);
                    ctx.fill();
                }
            });

            // 2. Draw Target (Projected)
            // Only draw if target is in front of camera (roughly)
            // For this demo, we assume 360 vision but projection scales with distance
            
            // Perspective Projection
            // x = relY, y = relZ, z = relX (depth)
            // We use a fixed depth offset to prevent division by zero/negative
            // Increased offset to push everything 'forward' into view
            const depth = relX + 15; 
            // Actually, if relX is positive, target is North (Forward).
            // If relX is negative, target is Behind.
            
            if (depth > 0.5) {
                const k = FOV_SCALE / depth;
                const tx = canvas.width/2 + relY * k;
                const ty = canvas.height/2 + relZ * k; // +Z is down in canvas
                
                // Target Size (scales with distance)
                const targetSize = Math.max(5, 500 / depth);
                
                // Draw Target Box
                ctx.strokeStyle = '#ef4444'; // Red
                ctx.lineWidth = 2;
                ctx.shadowColor = '#dc2626';
                ctx.shadowBlur = 20;
                
                // Box
                ctx.strokeRect(tx - targetSize/2, ty - targetSize/2, targetSize, targetSize);
                
                // Corner details
                ctx.fillStyle = '#ef4444';
                const gap = targetSize / 4;
                // ctx.fillRect(tx - targetSize/2 - 2, ty - targetSize/2 - 2, 4, 4); // corners...
                
                // Distance Label
                ctx.font = '12px Courier New';
                ctx.fillStyle = '#ef4444';
                ctx.fillText(`TGT: ${dist.toFixed(1)}m`, tx + targetSize/2 + 5, ty);
                
                // Lock Line (Leader line from center)
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(239, 68, 68, 0.3)';
                ctx.lineWidth = 1;
                ctx.moveTo(canvas.width/2, canvas.height/2);
                ctx.lineTo(tx, ty);
                ctx.stroke();
                
                // Reset shadow
                ctx.shadowBlur = 0;
                
                // Lock Logic Visuals
                const lockElem = document.getElementById('lock-status');
                const errLimit = 50; // pixels
                const screenDist = Math.sqrt((tx - canvas.width/2)**2 + (ty - canvas.height/2)**2);
                
                if (screenDist < errLimit) {
                    lockElem.innerText = "LOCKED";
                    lockElem.className = "text-red-500 font-bold animate-pulse";
                    // Draw Lock Circle
                    ctx.strokeStyle = '#22c55e'; // Green lock? Or keep red theme...
                    ctx.beginPath();
                    ctx.arc(tx, ty, targetSize * 0.8, 0, Math.PI*2);
                    ctx.stroke();
                } else {
                    lockElem.innerText = "TRACKING";
                    lockElem.className = "text-stone-500 font-bold";
                }
            } else {
                // Target behind camera
                document.getElementById('lock-status').innerText = "LOST (REAR)";
                
                // Draw arrow pointing down/back?
            }

            // 3. Update Telemetry Panels
            document.getElementById('range-display').innerText = dist.toFixed(2) + 'm';
            
            // Calculate Azimuth/Elevation angles
            const az = Math.atan2(relY, relX) * (180/Math.PI);
            const el = Math.atan2(-relZ, Math.sqrt(relX**2 + relY**2)) * (180/Math.PI); // -Z is up
            
            document.getElementById('azimuth-display').innerText = az.toFixed(1) + '°';
            document.getElementById('elevation-display').innerText = el.toFixed(1) + '°';
            
            // Update Error Bars (Visual)
            // Normalized error (0-100%)
            const maxErr = 10.0; // 10 meters
            const hErrPct = Math.min(100, (Math.abs(relY) / maxErr) * 100);
            const vErrPct = Math.min(100, (Math.abs(relZ) / maxErr) * 100);
            
            document.getElementById('h-error-bar').style.width = hErrPct + '%';
            document.getElementById('v-error-bar').style.width = vErrPct + '%';
            document.getElementById('h-error-val').innerText = relY.toFixed(1) + 'm';
            document.getElementById('v-error-val').innerText = relZ.toFixed(1) + 'm';

            animationId = requestAnimationFrame(draw);
        }
        
        requestAnimationFrame(draw);
    }
</script>
{% endblock %}

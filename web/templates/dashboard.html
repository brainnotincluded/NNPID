{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-6 py-12">
    <h1 class="text-4xl font-bold mb-8">Training <span class="gradient-text">Metrics</span></h1>

    <!-- Stats Row -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
        <div class="warrior-border bg-black/80 backdrop-blur p-6 group animate__animated animate__fadeInUp animate__delay-1s">
            <h4 class="text-red-500 text-xs font-bold uppercase tracking-[0.2em] mb-3 group-hover:text-white transition-colors">Total Episodes</h4>
            <div class="text-4xl font-black text-white group-hover:scale-110 transition-transform origin-left" id="total-episodes">-</div>
            <div class="h-1 w-8 bg-red-900 mt-4 group-hover:w-full group-hover:bg-red-600 transition-all duration-500"></div>
        </div>
        <div class="warrior-border bg-black/80 backdrop-blur p-6 group animate__animated animate__fadeInUp animate__delay-2s">
            <h4 class="text-red-500 text-xs font-bold uppercase tracking-[0.2em] mb-3 group-hover:text-white transition-colors">Current Reward</h4>
            <div class="text-4xl font-black text-white group-hover:scale-110 transition-transform origin-left" id="current-reward">-</div>
            <div class="h-1 w-8 bg-red-900 mt-4 group-hover:w-full group-hover:bg-red-600 transition-all duration-500"></div>
        </div>
        <div class="warrior-border bg-black/80 backdrop-blur p-6 group animate__animated animate__fadeInUp animate__delay-3s">
            <h4 class="text-red-500 text-xs font-bold uppercase tracking-[0.2em] mb-3 group-hover:text-white transition-colors">Critic Loss</h4>
            <div class="text-4xl font-black text-white group-hover:scale-110 transition-transform origin-left" id="critic-loss">-</div>
            <div class="h-1 w-8 bg-red-900 mt-4 group-hover:w-full group-hover:bg-red-600 transition-all duration-500"></div>
        </div>
        <div class="warrior-border bg-black/80 backdrop-blur p-6 group animate__animated animate__fadeInUp animate__delay-4s">
            <h4 class="text-red-500 text-xs font-bold uppercase tracking-[0.2em] mb-3 group-hover:text-white transition-colors">Actor Loss</h4>
            <div class="text-4xl font-black text-white group-hover:scale-110 transition-transform origin-left" id="actor-loss">-</div>
            <div class="h-1 w-8 bg-red-900 mt-4 group-hover:w-full group-hover:bg-red-600 transition-all duration-500"></div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Reward Chart -->
        <div class="warrior-border bg-black/80 backdrop-blur p-6 animate__animated animate__fadeInLeft animate__delay-5s relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-20 group-hover:opacity-100 transition-opacity">
                <span class="text-xs font-mono text-red-500 animate-pulse">LIVE_FEED</span>
            </div>
            <h3 class="text-xl font-bold mb-6 uppercase text-stone-200 tracking-wider">Episode Rewards</h3>
            <canvas id="rewardChart"></canvas>
        </div>

        <!-- Length Chart -->
        <div class="warrior-border bg-black/80 backdrop-blur p-6 animate__animated animate__fadeInRight animate__delay-5s relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-20 group-hover:opacity-100 transition-opacity">
                <span class="text-xs font-mono text-orange-500 animate-pulse">STEP_COUNT</span>
            </div>
            <h3 class="text-xl font-bold mb-6 uppercase text-stone-200 tracking-wider">Episode Length</h3>
            <canvas id="lengthChart"></canvas>
        </div>

        <!-- Loss Chart -->
        <div class="warrior-border bg-black/80 backdrop-blur p-6 lg:col-span-2 animate__animated animate__fadeInUp animate__delay-6s relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-20 group-hover:opacity-100 transition-opacity">
                <span class="text-xs font-mono text-blue-500 animate-pulse">NETWORK_OPTIMIZATION</span>
            </div>
            <h3 class="text-xl font-bold mb-6 uppercase text-stone-200 tracking-wider">Losses</h3>
            <canvas id="lossChart"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function fetchData() {
        try {
            const response = await fetch('/api/training-data');
            const data = await response.json();
            
            if (data.error) {
                console.error(data.error);
                return;
            }

            // Update Stats
            document.getElementById('total-episodes').innerText = data.episode[data.episode.length - 1];
            document.getElementById('current-reward').innerText = data.reward[data.reward.length - 1].toFixed(2);
            document.getElementById('critic-loss').innerText = data.critic_loss[data.critic_loss.length - 1].toFixed(4);
            document.getElementById('actor-loss').innerText = data.actor_loss[data.actor_loss.length - 1].toFixed(4);

            // Chart Configuration
            const commonOptions = {
                responsive: true,
                plugins: {
                    legend: { labels: { color: '#a8a29e', font: { family: 'Courier New' } } }
                },
                scales: {
                    y: { 
                        grid: { color: '#1c1917' }, 
                        ticks: { color: '#a8a29e', font: { family: 'Courier New' } },
                        border: { color: '#b91c1c' }
                    },
                    x: { 
                        grid: { color: '#1c1917' }, 
                        ticks: { color: '#a8a29e', font: { family: 'Courier New' } },
                        border: { color: '#b91c1c' }
                    }
                }
            };

            // Reward Chart
            new Chart(document.getElementById('rewardChart'), {
                type: 'line',
                data: {
                    labels: data.episode,
                    datasets: [{
                        label: 'Reward',
                        data: data.reward,
                        borderColor: '#dc2626', // Red-600
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: commonOptions
            });

            // Length Chart
            new Chart(document.getElementById('lengthChart'), {
                type: 'line',
                data: {
                    labels: data.episode,
                    datasets: [{
                        label: 'Steps',
                        data: data.length,
                        borderColor: '#ea580c', // Orange-600
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1
                    }]
                },
                options: commonOptions
            });

            // Loss Chart
            new Chart(document.getElementById('lossChart'), {
                type: 'line',
                data: {
                    labels: data.episode,
                    datasets: [
                        {
                            label: 'Critic Loss',
                            data: data.critic_loss,
                            borderColor: '#7f1d1d', // Red-900
                            borderWidth: 1,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'Actor Loss',
                            data: data.actor_loss,
                            borderColor: '#b91c1c', // Red-700
                            borderWidth: 1,
                            pointRadius: 0,
                            tension: 0.1
                        }
                    ]
                },
                options: commonOptions
            });

        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    fetchData();
</script>
{% endblock %}

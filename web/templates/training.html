{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-6 py-12">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-4xl font-black uppercase tracking-tighter flex items-center gap-4">
            <span class="text-red-600 animate-pulse">â– </span>
            Training <span class="gradient-text">Center</span>
        </h1>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Control Panel -->
        <div class="warrior-border bg-black/80 backdrop-blur p-6 h-fit animate__animated animate__fadeInLeft">
            <h3 class="text-lg font-bold mb-6 uppercase text-stone-200 tracking-widest border-b border-red-900/50 pb-2">
                Operations
            </h3>
            
            <div class="space-y-6">
                <!-- Status -->
                <div class="flex items-center justify-between p-4 bg-black border border-red-900/30">
                    <span class="text-stone-400 font-mono text-sm">STATUS</span>
                    <span id="training-status" class="px-3 py-1 bg-stone-900 text-stone-500 font-bold uppercase tracking-widest text-xs border border-stone-700">IDLE</span>
                </div>
                
                <!-- Progress Bar -->
                <div class="space-y-2">
                    <div class="flex justify-between text-xs font-mono">
                        <span class="text-stone-500">PROGRESS</span>
                        <span id="progress-text" class="text-red-500">0 / 0</span>
                    </div>
                    <div class="h-3 bg-black border border-red-900/30 overflow-hidden">
                        <div id="progress-bar" class="h-full bg-gradient-to-r from-red-900 to-red-600 transition-all duration-300 shadow-[0_0_10px_red]" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs font-mono text-stone-600">
                        <span id="progress-pct">0%</span>
                        <span id="progress-eta">ETA: --</span>
                    </div>
                </div>
                
                <!-- Live Stats -->
                <div class="grid grid-cols-2 gap-3 p-3 bg-black border border-red-900/30">
                    <div class="text-center">
                        <div class="text-xs text-stone-600 uppercase">Episode</div>
                        <div id="stat-episode" class="text-lg font-bold text-red-500 font-mono">-</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-stone-600 uppercase">Reward</div>
                        <div id="stat-reward" class="text-lg font-bold text-stone-300 font-mono">-</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-stone-600 uppercase">Actor Loss</div>
                        <div id="stat-actor" class="text-sm font-mono text-stone-400">-</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-stone-600 uppercase">Critic Loss</div>
                        <div id="stat-critic" class="text-sm font-mono text-stone-400">-</div>
                    </div>
                </div>

                <!-- Parameters -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-red-500 uppercase tracking-widest mb-2">Total Steps</label>
                        <input type="number" id="total-steps" value="100000" class="w-full bg-black border border-red-900/50 text-white px-4 py-2 focus:border-red-500 focus:outline-none font-mono">
                    </div>
                </div>

                <!-- Actions -->
                <div class="grid grid-cols-2 gap-4 pt-4">
                    <button onclick="startTraining()" id="btn-start" class="cyber-btn group flex items-center justify-center gap-2 hover:bg-red-600">
                        <span class="w-2 h-2 bg-red-500 rounded-full group-hover:bg-white animate-pulse"></span>
                        START
                    </button>
                    <button onclick="stopTraining()" id="btn-stop" class="px-4 py-3 border border-stone-700 text-stone-500 font-bold uppercase tracking-widest hover:bg-red-900/20 hover:text-red-500 hover:border-red-900 transition-all disabled:opacity-50" disabled>
                        ABORT
                    </button>
                </div>
            </div>
        </div>

        <!-- Configuration Editor -->
        <div class="warrior-border bg-black/80 backdrop-blur p-6 animate__animated animate__fadeInUp">
            <h3 class="text-lg font-bold mb-6 uppercase text-stone-200 tracking-widest border-b border-red-900/50 pb-2 flex justify-between items-center">
                Configuration
                <button onclick="saveConfig()" class="text-xs text-red-500 hover:text-white transition-colors">[ SAVE ]</button>
            </h3>
            
            <div class="space-y-6 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                <!-- Learning Rates -->
                <div class="space-y-3">
                    <h4 class="text-xs text-stone-500 font-bold uppercase">Hyperparameters</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-stone-400 block mb-1">Actor LR</label>
                            <input type="number" step="0.0001" class="config-input w-full bg-black border border-stone-800 text-stone-300 px-2 py-1 text-xs font-mono" 
                                   data-path="rsac.actor_lr" value="{{ config.rsac.actor_lr }}">
                        </div>
                        <div>
                            <label class="text-xs text-stone-400 block mb-1">Critic LR</label>
                            <input type="number" step="0.0001" class="config-input w-full bg-black border border-stone-800 text-stone-300 px-2 py-1 text-xs font-mono" 
                                   data-path="rsac.critic_lr" value="{{ config.rsac.critic_lr }}">
                        </div>
                        <div>
                            <label class="text-xs text-stone-400 block mb-1">Gamma</label>
                            <input type="number" step="0.01" class="config-input w-full bg-black border border-stone-800 text-stone-300 px-2 py-1 text-xs font-mono" 
                                   data-path="rsac.gamma" value="{{ config.rsac.gamma }}">
                        </div>
                        <div>
                            <label class="text-xs text-stone-400 block mb-1">Tau</label>
                            <input type="number" step="0.001" class="config-input w-full bg-black border border-stone-800 text-stone-300 px-2 py-1 text-xs font-mono" 
                                   data-path="rsac.tau" value="{{ config.rsac.tau }}">
                        </div>
                    </div>
                </div>

                <!-- Environment -->
                <div class="space-y-3 pt-4 border-t border-stone-900">
                    <h4 class="text-xs text-stone-500 font-bold uppercase">Physics & Rewards</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-stone-400 block mb-1">Max Steps</label>
                            <input type="number" class="config-input w-full bg-black border border-stone-800 text-stone-300 px-2 py-1 text-xs font-mono" 
                                   data-path="environment.max_episode_steps" value="{{ config.environment.max_episode_steps }}">
                        </div>
                        <div>
                            <label class="text-xs text-stone-400 block mb-1">Jerk Weight</label>
                            <input type="number" step="0.1" class="config-input w-full bg-black border border-stone-800 text-stone-300 px-2 py-1 text-xs font-mono" 
                                   data-path="reward.jerk_weight" value="{{ config.reward.jerk_weight }}">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Terminal Output -->
        <div class="warrior-border bg-black/80 backdrop-blur p-0 flex flex-col animate__animated animate__fadeInRight h-[600px]">
            <div class="p-4 border-b border-red-900/30 flex justify-between items-center bg-black">
                <span class="text-xs font-bold text-red-500 uppercase tracking-widest">SYSTEM LOGS</span>
                <div class="flex gap-2">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                    <span class="w-2 h-2 rounded-full bg-red-500/50"></span>
                    <span class="w-2 h-2 rounded-full bg-red-500/20"></span>
                </div>
            </div>
            <div id="terminal" class="flex-grow bg-black p-4 font-mono text-xs text-stone-400 overflow-y-auto custom-scrollbar leading-relaxed">
                <div class="text-stone-600">> System initialized...</div>
                <div class="text-stone-600">> Waiting for command...</div>
            </div>
        </div>
    </div>
</div>

<script>
    // Config State
    let currentConfig = {{ config | tojson }};
    let targetSteps = 100000;
    let startTime = null;
    let lastStep = 0;

    // Polling Loop
    setInterval(updateStatus, 1000);
    setInterval(updateTrainingData, 2000);

    async function startTraining() {
        const steps = document.getElementById('total-steps').value;
        targetSteps = parseInt(steps);
        startTime = Date.now();
        lastStep = 0;
        
        const btnStart = document.getElementById('btn-start');
        const btnStop = document.getElementById('btn-stop');
        
        btnStart.disabled = true;
        btnStart.classList.add('opacity-50', 'cursor-not-allowed');
        
        // Reset progress
        document.getElementById('progress-bar').style.width = '0%';
        document.getElementById('progress-text').innerText = `0 / ${targetSteps}`;
        document.getElementById('progress-pct').innerText = '0%';
        document.getElementById('progress-eta').innerText = 'ETA: calculating...';
        
        try {
            const res = await fetch(`/api/training/start?steps=${steps}`, { method: 'POST' });
            const data = await res.json();
            if(data.success) {
                logSystem("Training sequence initiated.");
                btnStop.disabled = false;
                btnStop.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                logSystem("Error: " + data.message, "error");
                btnStart.disabled = false;
                btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        } catch(e) {
            logSystem("Network failure.", "error");
        }
    }

    async function stopTraining() {
        const btnStop = document.getElementById('btn-stop');
        btnStop.innerText = "ABORTING...";
        
        try {
            const res = await fetch(`/api/training/stop`, { method: 'POST' });
            const data = await res.json();
            if(data.success) {
                logSystem("Training aborted by user.");
            }
        } catch(e) {
            logSystem("Failed to stop.", "error");
        }
        
        btnStop.innerText = "ABORT";
    }

    async function updateStatus() {
        try {
            const res = await fetch('/api/training/status');
            const data = await res.json();
            
            const statusBadge = document.getElementById('training-status');
            const btnStart = document.getElementById('btn-start');
            const btnStop = document.getElementById('btn-stop');

            if (data.is_running) {
                statusBadge.innerText = "RUNNING";
                statusBadge.className = "px-3 py-1 bg-red-900/20 text-red-500 font-bold uppercase tracking-widest text-xs border border-red-600 animate-pulse";
                btnStart.disabled = true;
                btnStart.classList.add('opacity-50', 'cursor-not-allowed');
                btnStop.disabled = false;
                btnStop.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                statusBadge.innerText = "IDLE";
                statusBadge.className = "px-3 py-1 bg-stone-900 text-stone-500 font-bold uppercase tracking-widest text-xs border border-stone-700";
                btnStart.disabled = false;
                btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
                btnStop.disabled = true;
                btnStop.classList.add('opacity-50', 'cursor-not-allowed');
            }

            // Update Logs
            const terminal = document.getElementById('terminal');
            // Check if new logs (simple check)
            const currentText = terminal.innerText;
            if (data.logs.length > 0) {
                // Clear old dummy logs if needed
                if (terminal.children.length < 3 && terminal.children[0].innerText.includes("System initialized")) {
                    terminal.innerHTML = "";
                }
                
                // Append new logs efficiently? 
                // For simplicity, just replace buffer for now to avoid duplications in this simple polling
                // A real system would use a cursor/timestamp.
                // We'll just show the last N lines provided by backend.
                terminal.innerHTML = data.logs.map(line => `<div>${line}</div>`).join('');
                terminal.scrollTop = terminal.scrollHeight;
            }

        } catch(e) {
            console.error(e);
        }
    }

    function logSystem(msg, type="info") {
        const terminal = document.getElementById('terminal');
        const color = type === "error" ? "text-red-500" : "text-stone-400";
        const div = document.createElement('div');
        div.className = color;
        div.innerText = `> ${msg}`;
        terminal.appendChild(div);
        terminal.scrollTop = terminal.scrollHeight;
    }

    async function saveConfig() {
        // Collect inputs
        document.querySelectorAll('.config-input').forEach(input => {
            const path = input.dataset.path.split('.');
            let obj = currentConfig;
            for(let i=0; i<path.length-1; i++) {
                obj = obj[path[i]];
            }
            // Detect type
            const val = parseFloat(input.value);
            obj[path[path.length-1]] = isNaN(val) ? input.value : val;
        });

        try {
            const res = await fetch('/api/training/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentConfig)
            });
            const data = await res.json();
            if (data.success) {
                logSystem("Configuration saved successfully.");
            } else {
                logSystem("Save failed: " + data.message, "error");
            }
        } catch(e) {
            logSystem("Config save error.", "error");
        }
    }
    
    async function updateTrainingData() {
        try {
            const res = await fetch('/api/training-data');
            if (!res.ok) return;
            
            const data = await res.json();
            if (data.episode && data.episode.length > 0) {
                const lastIdx = data.episode.length - 1;
                const currentStep = data.episode[lastIdx] * 200; // Approx steps (episode * avg_length)
                
                // Update stats
                document.getElementById('stat-episode').innerText = data.episode[lastIdx];
                document.getElementById('stat-reward').innerText = data.reward[lastIdx].toFixed(1);
                document.getElementById('stat-actor').innerText = data.actor_loss[lastIdx].toFixed(4);
                document.getElementById('stat-critic').innerText = data.critic_loss[lastIdx].toFixed(4);
                
                // Update progress bar
                if (targetSteps > 0) {
                    const pct = Math.min(100, (currentStep / targetSteps) * 100);
                    document.getElementById('progress-bar').style.width = pct + '%';
                    document.getElementById('progress-text').innerText = `${currentStep.toLocaleString()} / ${targetSteps.toLocaleString()}`;
                    document.getElementById('progress-pct').innerText = pct.toFixed(1) + '%';
                    
                    // ETA calculation
                    if (startTime && currentStep > lastStep) {
                        const elapsed = (Date.now() - startTime) / 1000; // seconds
                        const stepsPerSec = currentStep / elapsed;
                        const remaining = (targetSteps - currentStep) / stepsPerSec;
                        
                        if (remaining > 3600) {
                            document.getElementById('progress-eta').innerText = `ETA: ${(remaining/3600).toFixed(1)}h`;
                        } else if (remaining > 60) {
                            document.getElementById('progress-eta').innerText = `ETA: ${Math.round(remaining/60)}m`;
                        } else {
                            document.getElementById('progress-eta').innerText = `ETA: ${Math.round(remaining)}s`;
                        }
                        lastStep = currentStep;
                    }
                }
            }
        } catch(e) {
            // Ignore - no training data yet
        }
    }
</script>
{% endblock %}
